<div class="meg-featured-collection related-products megint-slider  section-id-{{ section.id }} collection-slider-row"
     data-section-id="{{ section.id }}"
     data-url="{{ routes.product_recommendations_url }}?section_id={{ section.id }}&limit={{ section.settings.grid }}&product_id={{ product.id }}"
        {%- render 'animation-attrs', attrs: 'data-cc-animate' -%}>

    {% if recommendations.performed? and recommendations.products_count > 0 %}
        <div class="container{% if section.settings.enable_carousel %} container--not-mobile{% endif %} {% if settings.use_fullwidth_layout %} container--no-max{% endif %} fully-spaced-row">
        {%- if section.settings.enable_carousel -%}
            <carousel-slider class="carousel block collection-slider">
                {%- endif -%}
                <h4 class="align-center hometitle  slider--mobile-container-pad  has-paging {% if section.settings.enable_carousel %} slider-nav{% endif %}">
                    {% if shop.locale == 'en' %}
                        {{ section.settings.title }}
                    {% else %}
                        {{ section.settings.title_fr }}
                    {% endif %}
                </h4>

                <div class="collection-listing related-collection {% if section.settings.enable_carousel %} slider {% if section.settings.full_width %}slider--edge-peek{% endif %} slider--mobile-container-pad slider--no-scrollbar{% endif %}">
                    <div class="product-grid product-grid--per-row-{{ section.settings.grid }} product-grid--per-row-mob-{{ settings.prod_thumb_mob_per_row }} {% if section.settings.enable_carousel %} slider__grid product-grid--carousel{% endif %}">
                        {%- liquid
                            if settings.prod_thumb_shape == 'portrait-23'
                                assign chosen_aspect_ratio = 0.67
                            elsif settings.prod_thumb_shape == 'portrait-45'
                                assign chosen_aspect_ratio = 0.8
                            elsif settings.prod_thumb_shape == 'square'
                                assign chosen_aspect_ratio = 1.0
                            elsif settings.prod_thumb_shape == 'landscape-54'
                                assign chosen_aspect_ratio = 1.25
                            elsif settings.prod_thumb_shape == 'landscape-32'
                                assign chosen_aspect_ratio = 1.50
                            elsif settings.prod_thumb_shape == 'tallest'
                                assign chosen_aspect_ratio = 99
                                for product in recommendations.products
                                    if product.featured_media.preview_image.aspect_ratio < chosen_aspect_ratio
                                        assign chosen_aspect_ratio = product.featured_media.preview_image.aspect_ratio
                                    endif
                                endfor
                            else
                                assign chosen_aspect_ratio = 0
                                for product in recommendations.products
                                    if product.featured_media.preview_image.aspect_ratio > chosen_aspect_ratio
                                        assign chosen_aspect_ratio = product.featured_media.preview_image.aspect_ratio
                                    endif
                                endfor
                            endif
                        -%}
                        {%- for product in recommendations.products -%}
                            {% if section.settings.enable_carousel %}
                                <div class="slider__item">
                            {% endif %}
                            {% render 'product-block', product: product, custom_aspect_ratio: chosen_aspect_ratio %}
                            {% if section.settings.enable_carousel %}
                                </div>
                            {% endif %}
                        {%- endfor -%}
                    </div>
                </div>
                {%- if section.settings.enable_carousel -%}
            </carousel-slider>
            {%- endif -%}
        </div>
        {%- if settings.quickbuy_style != 'off' -%}
                                                        {%- unless no_quick_buy_markup or no_quick_buy -%}
                                                            <div class="quickbuy-container use-color-scheme use-color-scheme--{{ settings.quickbuy_color_scheme }}">
                                                                <a href="#" class="close-detail" aria-label="{{ 'accessibility.close' | t }}" tabindex="-1">{% render 'icon-close', stroke_width: 1 %}</a>
                                                                <div class="inner"></div>
                                                            </div>
                                                        {%- endunless -%}
                                                    {%- endif -%}
    {% endif %}
</div>


{% javascript %}
var loadProductRecommendationsIntoSection = function() {
// Look for an element with class 'related-products'
var productRecommendationsSection = document.querySelector(".related-products");
if (productRecommendationsSection === null) { return; }
// Create request and submit it using Ajax
var request = new XMLHttpRequest();
request.open("GET", productRecommendationsSection.dataset.url);
request.onload = function() {
if (request.status >= 200 && request.status < 300) {
var container = document.createElement("div");
container.innerHTML = request.response;
productRecommendationsSection.innerHTML = container.querySelector(".related-products").innerHTML;
}
};
request.send();
};
// fetch when section reloads in editor
document.addEventListener("shopify:section:load", function(event) {
if (document.querySelector('[data-section-id="' + event.detail.sectionId + '"].related-products')) {
loadProductRecommendationsIntoSection();
}
});
// Fetching the recommendations on page load
loadProductRecommendationsIntoSection();
{% endjavascript %}


{% schema %}
{
  "name": "Related products",
  "class": "section-related-products",
  "settings": [
    {
      "type": "paragraph",
      "content": "Dynamic recommendations use order and product information to change and improve over time. [Learn more](https://help.shopify.com/en/themes/development/recommended-products)"
    },
    {
      "type": "text",
      "id": "title",
      "label": "Heading",
      "default": "You may also like"
    },
    {
      "type": "text",
      "id": "title_fr",
      "label": "Heading FR",
      "default": "VOUS AIMEREZ AUSSI"
    },
    {
      "type": "checkbox",
      "id": "show_vendor",
      "label": "Show product vendor",
      "default": false
    },
    {
      "type": "checkbox",
      "id": "enable_carousel",
      "label": "Enable Carousel",
      "default": true
    },
    {
      "type": "range",
      "id": "grid",
      "label": "Maximum products to show",
      "min": 2,
      "max": 5,
      "step": 1,
      "default": 4
    }
  ]
}
{% endschema %}
