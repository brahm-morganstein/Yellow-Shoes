{%- style -%}
  .section-{{ section.id }}-padding {
    padding-top: {{ section.settings.padding_top | times: 0.75 | round: 0 }}px;
    padding-bottom: {{ section.settings.padding_bottom | times: 0.75 | round: 0 }}px;
  }

  @media screen and (min-width: 750px) {
    .section-{{ section.id }}-padding {
      padding-top: {{ section.settings.padding_top }}px;
      padding-bottom: {{ section.settings.padding_bottom }}px;
    }
  }

  .image-compare {
    position: relative;
    width: 100%;
    max-width: {{ section.settings.container_width }}px;
    margin: 0 auto;
    overflow: hidden;
    cursor: ew-resize;
    user-select: none;
    border-radius: {{ section.settings.border_radius }}px;
  }

  .image-compare__container {
    position: relative;
    width: 100%;
    aspect-ratio: {{ section.settings.aspect_ratio }};
  }

  .image-compare__before,
  .image-compare__after {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
  }

  .image-compare__before {
    z-index: 1;
    width: 50%; /* Initial state */
    overflow: hidden;
  }

  .image-compare__img {
    display: block;
    width: 100%;
    height: 100%;
    object-fit: cover;
    pointer-events: none;
  }

  /* Handle / Slider Line */
  .image-compare__handle {
    position: absolute;
    top: 0;
    bottom: 0;
    left: 50%;
    width: 2px;
    background: #fff;
    z-index: 2;
    transform: translateX(-50%);
    pointer-events: none;
  }

  .image-compare__handle-button {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    width: 40px;
    height: 40px;
    background: #fff;
    border-radius: 50%;
    box-shadow: 0 0 10px rgba(0,0,0,0.2);
    display: flex;
    align-items: center;
    justify-content: center;
  }

  .image-compare__handle-button::before,
  .image-compare__handle-button::after {
    content: '';
    width: 0;
    height: 0;
    border-top: 6px solid transparent;
    border-bottom: 6px solid transparent;
  }

  .image-compare__handle-button::before {
    border-right: 8px solid #333;
    margin-right: 4px;
  }

  .image-compare__handle-button::after {
    border-left: 8px solid #333;
    margin-left: 4px;
  }
{%- endstyle -%}

<div class="section-{{ section.id }}-padding">
  <div class="image-compare" data-image-compare-container>
    <div class="image-compare__container">
      
      {%- if section.settings.after_image != blank -%}
        <div class="image-compare__after">
          {{ section.settings.after_image | image_url: width: 2000 | image_tag: class: 'image-compare__img', loading: 'lazy' }}
        </div>
      {%- else -%}
        <div class="image-compare__after" style="background: #eee; display: flex; align-items: center; justify-content: center;">After Image</div>
      {%- endif -%}

      {%- if section.settings.before_image != blank -%}
        <div class="image-compare__before" data-image-compare-before>
          {%- comment -%}The 'before' image needs to maintain the full width of the container even when clipped{%- endcomment -%}
          <div style="width: {{ section.settings.container_width }}px; height: 100%; position: relative;">
             {{ section.settings.before_image | image_url: width: 2000 | image_tag: class: 'image-compare__img', loading: 'lazy' }}
          </div>
        </div>
      {%- else -%}
        <div class="image-compare__before" data-image-compare-before style="background: #ccc; display: flex; align-items: center; justify-content: center;">Before Image</div>
      {%- endif -%}

      <div class="image-compare__handle" data-image-compare-handle>
        <div class="image-compare__handle-button"></div>
      </div>
    </div>
  </div>
</div>

<script>
  if (!customElements.get('image-compare')) {
    const initCompare = () => {
      const containers = document.querySelectorAll('[data-image-compare-container]');
      
      containers.forEach(container => {
        const before = container.querySelector('[data-image-compare-before]');
        const handle = container.querySelector('[data-image-compare-handle]');
        
        const move = (e) => {
          let x = e.type.includes('touch') ? e.touches[0].clientX : e.clientX;
          let rect = container.getBoundingClientRect();
          let position = ((x - rect.left) / rect.width) * 100;
          
          if (position >= 0 && position <= 100) {
            before.style.width = position + '%';
            handle.style.left = position + '%';
          }
        };

        container.addEventListener('mousemove', move);
        container.addEventListener('touchmove', move);
      });
    };

    document.addEventListener('DOMContentLoaded', initCompare);
    // Re-init for theme editor
    if (Shopify.designMode) {
      document.addEventListener('shopify:section:load', initCompare);
    }
  }
</script>

{% schema %}
{
  "name": "Image Comparison",
  "settings": [
    {
      "type": "image_picker",
      "id": "before_image",
      "label": "Before Image (Overlay)"
    },
    {
      "type": "image_picker",
      "id": "after_image",
      "label": "After Image (Background)"
    },
    {
      "type": "select",
      "id": "aspect_ratio",
      "label": "Aspect Ratio",
      "options": [
        { "value": "16 / 9", "label": "Widescreen (16:9)" },
        { "value": "4 / 3", "label": "Standard (4:3)" },
        { "value": "1 / 1", "label": "Square (1:1)" }
      ],
      "default": "16 / 9"
    },
    {
      "type": "range",
      "id": "container_width",
      "min": 600,
      "max": 1600,
      "step": 100,
      "unit": "px",
      "label": "Max Container Width",
      "default": 1200
    },
    {
      "type": "range",
      "id": "border_radius",
      "min": 0,
      "max": 40,
      "step": 2,
      "unit": "px",
      "label": "Corner Rounding",
      "default": 0
    },
    {
      "type": "header",
      "content": "Section Padding"
    },
    {
      "type": "range",
      "id": "padding_top",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Top Padding",
      "default": 36
    },
    {
      "type": "range",
      "id": "padding_bottom",
      "min": 0,
      "max": 100,
      "step": 4,
      "unit": "px",
      "label": "Bottom Padding",
      "default": 36
    }
  ],
  "presets": [
    {
      "name": "Image Comparison"
    }
  ]
}
{% endschema %}