{% liquid
  assign subtotal_cents = cart.original_total_price
  assign subtotal_dollars = subtotal_cents | divided_by: 100.0
  assign subtotal = subtotal_dollars 
  assign item_count = cart.item_count

  assign number_of_tier = section.settings.progress_bar_nb_tier
  assign number_of_tier_int = number_of_tier | plus: 0
  assign tier_type = section.settings.tier_type
  assign tier_reward_type = section.settings.tier_reward_type

  assign tier_1_reward_text = section.settings.tier_1_reward_text
  assign tier_1_value = section.settings.tier_1_value
  assign tier_1_reward_value = section.settings.tier_1_reward_value
  assign is_tier_1_free_shipping = section.settings.tier_1_free_shipping

  assign tier_2_reward_text = section.settings.tier_2_reward_text
  assign tier_2_value = section.settings.tier_2_value
  assign tier_2_reward_value = section.settings.tier_2_reward_value

  assign tier_3_reward_text = section.settings.tier_3_reward_text
  assign tier_3_value = section.settings.tier_3_value
  assign tier_3_reward_value = section.settings.tier_3_reward_value

  if shop.locale != 'en'
    assign tier_1_reward_text = section.settings.tier_1_reward_text_fr
    assign tier_2_reward_text = section.settings.tier_2_reward_text_fr
    assign tier_3_reward_text = section.settings.tier_3_reward_text_fr
  endif

  if tier_type == "money"
      assign tier_1_condition = false
      if subtotal_dollars < tier_1_value
          assign tier_1_condition = true
      endif

      assign tier_1_progress_condition = false
      if subtotal_dollars <= tier_1_value
          assign tier_1_progress_condition = true
      endif
      assign remaining = tier_1_value | minus: subtotal_dollars
      assign msg_tier_1 = "$" | append: remaining | append: " more to get " | append: tier_1_reward_text
      if shop.locale != 'en'
          assign msg_tier_1 = "Encore " | append: remaining | append: "$ pour bénéficier de " | append: tier_1_reward_text
      endif  
      assign tier_1_progress = subtotal_dollars | times: 33.33 | divided_by: tier_1_value

      assign tier_2_condition = false
      if subtotal_dollars < tier_2_value
          assign tier_2_condition = true
      endif

      assign tier_2_progress_condition = false
      if subtotal_dollars <= tier_2_value
          assign tier_2_progress_condition = true
      endif  
      assign remaining = tier_2_value | minus: subtotal_dollars
      assign msg_tier_2 = "$" | append: remaining | append: " more to get " | append: tier_2_reward_text
      if shop.locale != 'en'
          assign msg_tier_2 = "Encore " | append: remaining | append: "$ pour bénéficier de " | append: tier_2_reward_text
      endif  
      assign remaining = subtotal | minus: tier_1_value
      assign second_segment = remaining | times: 33.33 | divided_by: 25
      assign tier_2_progress = 33.33 | plus: second_segment

      assign tier_3_condition = false
      if subtotal_dollars < tier_3_value
          assign tier_3_condition = true
      endif

      assign tier_3_progress_condition = false
      if subtotal_dollars <= tier_3_value
          assign tier_3_progress_condition = true
      endif  
      assign remaining = tier_3_value | minus: subtotal_dollars
      assign msg_tier_3 = "$" | append: remaining | append: " more to get " | append: tier_3_reward_text
      if shop.locale != 'en'
          assign msg_tier_3 = "Encore " | append: remaining | append: "$ pour bénéficier de " | append: tier_3_reward_text
      endif  
      assign remaining = subtotal | minus: tier_2_value
      assign third_segment = remaining | times: 33.34 | divided_by: 25
      assign tier_3_progress = 66.66 | plus: third_segment        


  else
      assign tier_1_condition = false
      if item_count < tier_1_value
          assign tier_1_condition = true
      endif

      assign tier_1_progress_condition = false
      if item_count <= tier_1_value
          assign tier_1_progress_condition = true
      endif
      assign remaining = tier_1_value | minus: item_count
      assign tier_1_progress = item_count | times: 33.33 | divided_by: tier_1_value
      assign msg_tier_1 = "Add " | append: remaining | append: " more item to get " | append: tier_1_reward_text
      if shop.locale != 'en'
          assign msg_tier_1 = "Ajouter " | append: remaining | append: "item pour bénéficier de " | append: tier_1_reward_text
      endif
      
      assign tier_2_condition = false
      if item_count < tier_2_value
          assign tier_2_condition = true
      endif

      assign tier_2_progress_condition = false
      if item_count <= tier_2_value
          assign tier_2_progress_condition = true
      endif
      assign remaining = tier_2_value | minus: item_count
      assign msg_tier_2 = "Add " | append: remaining | append: " more item to get " | append: tier_2_reward_text
      if shop.locale != 'en'
          assign msg_tier_2 = "Ajouter " | append: remaining | append: "item pour bénéficier de " | append: tier_2_reward_text
      endif  
      assign remaining = item_count | minus: tier_1_value
      assign second_segment = remaining | times: 33.33
      assign tier_2_progress = 33.33 | plus: second_segment

      assign tier_3_condition = false
      if item_count < tier_3_value
          assign tier_3_condition = true
      endif

      assign tier_3_progress_condition = false
      if item_count <= tier_3_value
          assign tier_3_progress_condition = true
      endif    
      assign remaining = tier_3_value | minus: item_count
      assign msg_tier_3 = "Add " | append: remaining | append: " more item to get " | append: tier_3_reward_text
      if shop.locale != 'en'
          assign msg_tier_3 = "Ajouter " | append: remaining | append: "item pour bénéficier de " | append: tier_3_reward_text
      endif  
      assign remaining = item_count | minus: tier_2_value
      assign third_segment = remaining | times: 33.34
      assign tier_3_progress = 66.66 | plus: third_segment      
      
  endif
    


  if tier_1_condition
      assign msg = msg_tier_1
  elsif tier_2_condition
      assign msg = msg_tier_2
  elsif tier_3_condition
      assign msg = msg_tier_3   
  else
      assign remaining = 0
      assign msg = "Maximum reward reached"
      if shop.locale != 'en'
      assign msg = "Récompense maximale atteinte"
      endif   
  endif

  assign subtotal = subtotal_dollars

  if tier_1_progress_condition
      assign progress = tier_1_progress
  elsif tier_2_progress_condition
      assign progress = tier_2_progress
  elsif tier_3_progress_condition
      assign progress = tier_3_progress
  else
      assign progress = 100
  endif 

    
%}

<script>
    //alert('{{ progress }}')
</script>

<div>
  <link rel="stylesheet" href="{{ 'cart_progress_bar.s.min.css' | asset_url }}">

  <div class="progress-bar progress-bar--gwp">
    <p class="progress-bar__subheading text-center" style="color:#000;">
      {{ msg }}
    </p>

    <div class="progress-bar__body" style="margin-top: 28px;">
      <div class="progress-bar__progress" style="--height: 26px; --percentage: {{ progress }}%; --bg-progress: linear-gradient(90deg, #A5C792 0%, #6CAD47 100%);">
        
        <div class="progress-bar__progress-candycane-bg"></div>

        {% if number_of_tier == "3" %}
            <!-- Milestone Dots -->
            <div class="progress-bar__dot progress-bar__dot--amount" style="left: 17.0%;">
            <span class="money">
                {% if tier_type == "money"%}
                    {% if shop.locale == 'en' %}${{tier_1_value}}{% else %}{{tier_1_value}}${% endif %}
                {% else %}
                    {% if shop.locale == 'en' %}{{tier_1_value}} item{% else %}{{tier_1_value}} article{% endif %}
                {% endif %}
            </span>
            </div>
            <div class="progress-bar__dot progress-bar__dot--amount" style="left: 50.0%;">
            <span class="money">
                {% if tier_type == "money"%}
                    {% if shop.locale == 'en' %}${{tier_2_value}}{% else %}{{tier_2_value}}${% endif %}
                {% else %}
                    {% if shop.locale == 'en' %}{{tier_2_value}} item{% else %}{{tier_2_value}} article{% endif %}
                {% endif %}
            </span>
            </div>
            <div class="progress-bar__dot progress-bar__dot--amount" style="left: 83.0%;">
            <span class="money">
                {% if tier_type == "money"%}
                    {% if shop.locale == 'en' %}${{tier_3_value}}{% else %}{{tier_3_value}}${% endif %}
                {% else %}
                    {% if shop.locale == 'en' %}{{tier_3_value}} item{% else %}{{tier_3_value}} article{% endif %}
                {% endif %}
            </span>
            </div>

            <!-- Dividers -->
            <span class="progress-bar__divider progress-bar__divider--clip" style="--left: 33.3333%;"></span>
            <span class="progress-bar__divider progress-bar__divider--clip" style="--left: 66.6667%;"></span>
        {% endif %}

        <!-- Tooltip (only if progress < 100%) -->
        {% if progress < 100 %}
          <div class="progress-bar__tooltip" style="--left: {{ progress }}%;">
            <span class="money">{% if tier_type == "money"%}{{- cart.original_total_price | money -}}{% else %}{{item_count}}{% endif %}</span>
          </div>
        {% endif %}

      </div>
    </div>

    <!-- Label List -->
    <div class="progress-bar__label">
      <ul class="progress-bar__label__list">
        {% for i in (1..number_of_tier_int) %}
        <li class="progress-bar__label__item">
          {% liquid
            if i == 1
              assign progress_label = tier_1_reward_text
            endif
            if i == 2
              assign progress_label = tier_2_reward_text
            endif
            if i == 3
              assign progress_label = tier_3_reward_text
            endif                        
          %}
          <span>{{ progress_label }}</span>
        </li>
        {% endfor %}
      </ul>
    </div>

  </div>
</div>

<script>


  function updateCartProgressBar(subtotal, item_count){
    let percentage = calculateProgressBar(subtotal, item_count)
    let language = '{{ shop.locale }}'
    let _subtotal = subtotal.toFixed(2)
    _subtotal = language == 'en' ? "$"+_subtotal : _subtotal+"$";
    {% if tier_type == "money" %}
    $(".progress-bar__tooltip").first().find('.money').first().html(`${_subtotal}`)
    {% else %}
      $(".progress-bar__tooltip").first().find('.money').first().html(`${item_count}`)
    {% endif %}
    
    let msg = getRewardMessage(subtotal, item_count)
    
    $(".progress-bar__subheading").first().html(msg)
    $(".progress-bar__tooltip").first().css('--left',`${percentage}%`)
    $(".progress-bar__progress").first().css('--percentage',`${percentage}%`)
    
    console.log(percentage,remaining,msg)
  }

function getRewardMessage(subtotalDollars, item_count) {
  let msg;
  let language = '{{ shop.locale }}'
  {% if tier_type == "money" %}
  if (subtotalDollars < parseFloat('{{ tier_1_value }}')) {
    remaining = parseFloat('{{ tier_1_value }}') - subtotalDollars;
    remaining = remaining.toFixed(2)
    remainingInDollars = language == 'en' ? "$"+remaining : remaining+"$";
    msg = language == 'en' ? `${remainingInDollars} more to get {{ tier_1_reward_text }}.` : `Encore ${remainingInDollars} pour bénéficier de {{ tier_1_reward_text }}.`;
  } else if (subtotalDollars < parseFloat('{{ tier_2_value }}')) {
    remaining = parseFloat('{{ tier_2_value }}') - subtotalDollars;
    remaining = remaining.toFixed(2)
    remainingInDollars = language == 'en' ? "$"+remaining : remaining+"$";
    msg = language == 'en' ? `${remainingInDollars} more to get {{ tier_2_reward_text }}.`: `Encore ${remainingInDollars} pour obtenir {{ tier_2_reward_text }} de réduction`;
  } else if (subtotalDollars < parseFloat('{{ tier_3_value }}')) {
    remaining = parseFloat('{{ tier_3_value }}') - subtotalDollars;
    remaining = remaining.toFixed(2)
    remainingInDollars = language == 'en' ? "$"+remaining : remaining+"$";
    msg = language == 'en' ? `${remainingInDollars} more to get {{ tier_3_reward_text }}.` : `Encore ${remainingInDollars} pour obtenir {{ tier_3_reward_text }}`;
  } else {
    remaining = 0;
    msg = language == 'en' ? "Maximum reward reached" : "Récompense maximale atteinte";
  }
{% else %}
  if (item_count < parseInt('{{ tier_1_value }}')) {
    remaining = parseInt('{{ tier_1_value }}') - item_count;
    msg = language == 'en' ? ` Add ${remaining} more item to get {{ tier_1_reward_text }}.`: `Ajouter ${remaining} article pour obtenir {{ tier_1_reward_text }}`;
  } else if (item_count < parseInt('{{ tier_2_value }}')) {
    remaining = parseInt('{{ tier_2_value }}') - item_count;
    msg = language == 'en' ? ` Add ${remaining} more item to get {{ tier_2_reward_text }}.`: `Ajouter ${remaining} article pour obtenir {{ tier_2_reward_text }}`;
  } else if (item_count < parseInt('{{ tier_3_value }}')) {
    remaining = parseInt('{{ tier_3_value }}') - item_count;
    msg = language == 'en' ? ` Add ${remaining} more item to get {{ tier_3_reward_text }}.`: `Ajouter ${remaining} article pour obtenir {{ tier_3_reward_text }}`;
  } else {
    remaining = 0;
    msg = language == 'en' ? "Maximum reward reached" : "Récompense maximale atteinte";
  }
{% endif %}

  return msg;
} 

function calculateProgressBar(subtotal, item_count) {
  let progress = 0;

  {% if tier_type == "money" %}
  if (subtotal <= parseFloat('{{ tier_1_value }}')) {
    // First segment: $0 - $75 → 0% to 33.33%
    progress = (subtotal / parseFloat('{{ tier_1_value }}')) * 33.33;
  } else if (subtotal <= parseFloat('{{ tier_2_value }}')) {
    // Second segment: $75 - $100 → 33.33% to 66.66%
    progress = 33.33 + ((subtotal - parseFloat('{{ tier_1_value }}')) / 25) * 33.33;
  } else if (subtotal <= parseFloat('{{ tier_3_value }}')) {
    // Third segment: $100 - $125 → 66.66% to 100%
    progress = 66.66 + ((subtotal - parseFloat('{{ tier_2_value }}')) / 25) * 33.34;
  } else {
    progress = 100;
  }
{% else %}
    if (item_count <= parseInt('{{ tier_1_value }}')) {
      // 0 → 2 items maps to 0% → 33.33%
      progress = (item_count / parseInt('{{ tier_1_value }}')) * 33.33;
    } else if (item_count <= parseInt('{{ tier_2_value }}')) {
      // 2 → 3 items maps to 33.33% → 66.66%
      progress = 33.33 + ((item_count - parseInt('{{ tier_1_value }}')) / 1) * 33.33;
    } else if (item_count <= parseInt('{{ tier_3_value }}')) {
      // 3 → 4 items maps to 66.66% → 100%
      progress = 66.66 + ((item_count - parseInt('{{ tier_2_value }}')) / 1) * 33.34;
    } else {
      progress = 100;
    }
{% endif %}

  return Math.min(progress, 100); // Clamp to 100%
}
  
document.addEventListener('on:cart:after-merge', async (event) => {
  // your code here
  console.log(event)
  const cartResponse = await fetch('https://www.yellowshoes.com/cart.json');
  const cartData = await cartResponse.json();
  console.log('cartData',cartData)
  let subtotal = cartData.original_total_price / 100;
  subtotal = Number.parseFloat(subtotal.toString().replace('$',''));
  const item_count = cartData.item_count;
  updateCartProgressBar(subtotal, item_count)
});
  
</script>