{% liquid
  assign subtotal_cents = cart.original_total_price
  assign subtotal_dollars = subtotal_cents | divided_by: 100.0

  if subtotal_dollars < 85
    assign remaining = 85 | minus: subtotal_dollars
    assign remaining_in_dollars = remaining 
    assign msg = "$" | append: remaining_in_dollars | append: " more to get Free shipping."
    if shop.locale != 'en'
      assign msg = "Encore " | append: remaining_in_dollars | append: "$ pour bénéficier de la livraison gratuite."
    endif   
  else
    assign remaining = 0
    assign msg = "Maximum reward reached"
    if shop.locale != 'en'
      assign msg = "Récompense maximale atteinte"
    endif   
  endif

 assign subtotal = subtotal_dollars

  if subtotal <= 85
    assign progress = subtotal | times: 100 |divided_by: 85 
  else
    assign progress = 100
  endif   
%}



<div>
  <link rel="stylesheet" href="{{ 'cart_progress_bar.s.min.css' | asset_url }}">

  <div class="progress-bar progress-bar--gwp">
    <p class="progress-bar__subheading text-center" style="color:#000;">
      {{ msg }}
    </p>

    <div class="progress-bar__body" style="margin-top: 28px;">
      <div class="progress-bar__progress" style="--height: 26px; --percentage: {{ progress }}%; --bg-progress: linear-gradient(90deg, #A5C792 0%, #6CAD47 100%);">
        
        <div class="progress-bar__progress-candycane-bg"></div>

        <!-- Milestone Dots -->
        <div class="progress-bar__dot progress-bar__dot--amount" style="left: 50%;">
          <span class="money">{% if shop.locale == 'en' %}$85{% else %}85${% endif %}</span>
        </div>

        <!-- Tooltip (only if progress < 100%) -->
        {% if progress < 100 %}
          <div class="progress-bar__tooltip" style="--left: {{ progress }}%;">
            <span class="money">{{- cart.original_total_price | money -}}</span>
          </div>
        {% endif %}

      </div>
    </div>

    <!-- Label List -->
    <div class="progress-bar__label">
      <ul class="progress-bar__label__list">
        <li class="progress-bar__label__item">
          <span></span>
        </li>
        <li class="progress-bar__label__item">
          <span>{% if shop.locale == 'en' %}Free shipping{% else %}Livraison gratuite{% endif %}</span>
        </li>
        <li class="progress-bar__label__item">
          <span></span>
        </li>
      </ul>
    </div>

  </div>
</div>

<script>


  function updateCartProgressBar(subtotal){
    let percentage = calculateProgressBar(subtotal)
    let language = '{{ shop.locale }}'
    let _subtotal = subtotal.toFixed(2)
    _subtotal = language == 'en' ? "$"+_subtotal : _subtotal+"$";
    $(".progress-bar__tooltip").first().find('.money').first().html(`${_subtotal}`)
    
    let msg = getRewardMessage(subtotal)
    
    $(".progress-bar__subheading").first().html(msg)
    $(".progress-bar__tooltip").first().css('--left',`${percentage}%`)
    $(".progress-bar__progress").first().css('--percentage',`${percentage}%`)
    
    console.log(percentage,remaining,msg)
  }

function getRewardMessage(subtotalDollars) {
  let msg;
  let language = '{{ shop.locale }}'
  if (subtotalDollars < 85) {
    remaining = 85 - subtotalDollars;
    remaining = remaining.toFixed(2)
    remainingInDollars = language == 'en' ? "$"+remaining : remaining+"$";
    msg = language == 'en' ? `${remainingInDollars} more to get Free shipping.` : `Encore ${remainingInDollars} pour bénéficier de la livraison gratuite.`;
  }  else {
    remaining = 0;
    msg = language == 'en' ? "Maximum reward reached" : "Récompense maximale atteinte";
  }

  return msg;
}  

function calculateProgressBar(subtotal) {
  let progress = 0;

  if (subtotal <= 85) {
    // First segment: $0 - $85 → 0% to 33.33%
    progress = (subtotal / 85) * 100;
  } else {
    progress = 100;
  }

  return Math.min(progress, 100); // Clamp to 100%
}
  
document.addEventListener('on:cart:after-merge', async (event) => {
  // your code here
  console.log(event)
  const cartResponse = await fetch('https://www.yellowshoes.com/cart.json');
  const cartData = await cartResponse.json();
  let subtotal = cartData.original_total_price / 100;
  subtotal = Number.parseFloat(subtotal.toString().replace('$',''));
  updateCartProgressBar(subtotal)
});
  
</script>